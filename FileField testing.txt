## üöÄ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Django FileField**

***

### **‚úÖ –ë–∞–∑–æ–≤—ã–π —Ç–µ—Å—Ç FileField**

```python
# ads/tests.py
from django.test import TestCase
from django.core.files.uploadedfile import SimpleUploadedFile
from django.urls import reverse
from ads.models import Ad
import os

class TestAdFileField(TestCase):
    def setUp(self):
        self.client = Client()
        self.user = User.objects.create_user('admin', '123')
        self.client.login(username='admin', password='123')
        self.create_url = reverse('ads:ad-create')

    def test_file_upload_create(self):
        """–¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏"""
        # üî• –°–æ–∑–¥–∞—ë–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
        test_image = SimpleUploadedFile(
            name='test_banner.jpg',
            content=b'fake image content',
            content_type='image/jpeg'
        )
        
        data = {
            'name': '–¢–µ—Å—Ç —Ä–µ–∫–ª–∞–º—ã',
            'budget': 1000,
            'image': test_image,  # ‚Üê FileField!
        }
        
        response = self.client.post(self.create_url, data)
        self.assertEqual(response.status_code, 302)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Å —Ñ–∞–π–ª–æ–º
        ad = Ad.objects.get(name='–¢–µ—Å—Ç —Ä–µ–∫–ª–∞–º—ã')
        self.assertTrue(ad.image)  # —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω
        self.assertTrue(os.path.exists(ad.image.path))
        self.assertEqual(ad.image.name, 'ads/test_banner.jpg')

    def test_file_upload_update(self):
        """–¢–µ—Å—Ç –∑–∞–º–µ–Ω—ã —Ñ–∞–π–ª–∞ –≤ UpdateView"""
        # –°–æ–∑–¥–∞—ë–º —Ä–µ–∫–ª–∞–º—É —Å —Ñ–∞–π–ª–æ–º
        test_image1 = SimpleUploadedFile('old.jpg', b'old content', 'image/jpeg')
        ad = Ad.objects.create(name='–°—Ç–∞—Ä—ã–π –±–∞–Ω–Ω–µ—Ä', image=test_image1, created_by=self.user)
        
        # –ù–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        test_image2 = SimpleUploadedFile('new.jpg', b'new content', 'image/jpeg')
        
        update_url = reverse('ads:ad-update', kwargs={'pk': ad.pk})
        data = {
            'name': '–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –±–∞–Ω–Ω–µ—Ä',
            'image': test_image2,
        }
        
        self.client.post(update_url, data)
        ad.refresh_from_db()
        
        self.assertEqual(ad.name, '–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –±–∞–Ω–Ω–µ—Ä')
        self.assertEqual(ad.image.name, 'ads/new.jpg')
```

***

### **üîç –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤**

```python
def create_test_image(self, name='test.png', size=(100, 100)):
    """–°–æ–∑–¥–∞—ë—Ç —Ä–µ–∞–ª—å–Ω–æ–µ PNG –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"""
    from PIL import Image
    from io import BytesIO
    
    img = Image.new('RGB', size, color='red')
    buffer = BytesIO()
    img.save(buffer, format='PNG')
    return SimpleUploadedFile(
        name=name,
        content=buffer.getvalue(),
        content_type='image/png'
    )

def test_real_image(self):
    image_file = self.create_test_image()
    data = {'name': 'test', 'image': image_file}
    self.client.post(self.create_url, data)
```

***

### **‚úÖ –¢–µ—Å—Ç—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏ FileField**

```python
def test_file_size_validation(self):
    """–¢–µ—Å—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞"""
    # –ë–æ–ª—å—à–æ–π —Ñ–∞–π–ª (>2MB)
    large_file = SimpleUploadedFile(
        'huge.jpg',
        b'a' * (2 * 1024 * 1024 + 1),  # 2MB + 1 –±–∞–π—Ç
        'image/jpeg'
    )
    
    data = {'name': 'test', 'image': large_file}
    response = self.client.post(self.create_url, data)
    
    self.assertEqual(response.status_code, 200)
    self.assertFormError(response.context['form'], 'image', '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä 2MB')

def test_file_type_validation(self):
    """–¢–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"""
    wrong_file = SimpleUploadedFile('script.exe', b'malware', 'application/x-msdownload')
    data = {'name': 'test', 'image': wrong_file}
    
    response = self.client.post(self.create_url, data)
    self.assertFormError(response.context['form'], 'image', '–¢–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è!')
```

***

### **üîç –ú–æ–¥–µ–ª—å —Å FileField**

```python
# ads/models.py
class Ad(models.Model):
    name = models.CharField(max_length=255)
    image = models.ImageField(upload_to='ads/', validators=[
        FileExtensionValidator(['jpg', 'png']),
        FileSizeValidator(2 * 1024 * 1024)  # 2MB
    ])
    created_by = models.ForeignKey(User, on_delete=models.CASCADE)
```

***

### **‚úÖ –¢–µ—Å—Ç —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞**

```python
def test_delete_file(self):
    """–¢–µ—Å—Ç –æ—á–∏—Å—Ç–∫–∏ FileField"""
    test_image = SimpleUploadedFile('banner.jpg', b'image', 'image/jpeg')
    ad = Ad.objects.create(name='test', image=test_image, created_by=self.user)
    
    # POST —Å –ø—É—Å—Ç—ã–º —Ñ–∞–π–ª–æ–º = —É–¥–∞–ª–µ–Ω–∏–µ
    update_url = reverse('ads:ad-update', kwargs={'pk': ad.pk})
    data = {'name': '–±–µ–∑ —Ñ–æ—Ç–æ'}
    
    self.client.post(update_url, data)
    ad.refresh_from_db()
    
    self.assertIsNone(ad.image)  # —Ñ–∞–π–ª —É–¥–∞–ª—ë–Ω
```

***

### **üöÄ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤**

```bash
python manage.py test ads.tests.TestAdFileField -v 2
```

**`SimpleUploadedFile`** + **`content_type`** = **—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è —Ç–µ—Å—Ç–æ–≤**! üöÄ